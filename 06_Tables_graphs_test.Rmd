---
title: "Vikkilen, various tables and plots"
author: "DHJ"
date: "24 6 2019"
output: 
  html_document:
    toc: true
    toc_float: true  
---

## General
- percentage sterile females (%S) = (number of sterile females/total number of females)*100
    - stage 2-4 females are sterile
- mean Female Penis Length (FPL)
- mean Male Penis Length (MPL)
For N. lapillus,
- Relative Penis Size Index (RPSI) = (FPL)3/(MPL)3*100 
- imposex index (VDSI) = (sum of the values of imposex stages (ranged 0 to 5) in all females/the number of females collected)
For B. undatum
- Penis Classification Index (PCI) after Strand and Jacobsen (2002)


#### Modification 1  
From Merete 20.11.2019
Du er absolutt ikke tungnem, Dag. Det er heller jeg som ikke har fullstendig oversikt n√•r jeg ikke har jobbet med det p√• en stund. Jeg har kikket n√¶rmere p√• dette, og vi b√∏r beholde PRL (prostatalengde), men heller kalle det FPrL (average female prostate length= sum of prostate lengths (mm) of all sampled/number of females) i figurene 3 b og c. Vi bytter TBT fra y-aksen til x-aksen i figur 3 c (det fungerte godt i imposex-artikkelen v√•r).

Hannen til strandsneglen kan kaste penis, derfor tror jeg ikke at det blir brukt RPLI (Relative Penis Length Index). Men det ser ut til √• v√¶re en peniskjertelindeks (PKI) som Lise har regnet ut. PKI = Œ£ ant. peniskjertler hos alle innsamlede hanner/antall hanner. Vi kan vente litt med dette og evt. heller ta det med i artikkelen. Jeg kommer ikke til √• ta det med i abstractet til SETAC

Hvis du har tid, er det signifikante trender for b√•de TBT og ISI (der hvor det er nok data for utregning)?
Er det god korrelasjon (Kendall?) mellom TBT og ISI, TBT og FPrL og ISI og FPrL?

S√• spennende √• v√¶re p√• m√∏te med TBT-ekspert. Jeg skal tenke p√• om jeg har noen sp√∏rsm√•l. Her g√•r det i justering av MILKYS-rapport.

Takk for god hjelp, Dag! üòä


#### Modification 2  
From: Merete Sch√∏yen  
Sent: tirsdag 7. april 2020 17:08  
  
Jeg lurer p√• om du kan justere figuren nedenfor. F√∏lgende m√• gj√∏res:  
1. Vi sl√•r sammen st. 5 og st. 5B og kaller stasjonen ¬´Skjeviga¬ª.   
2. Vi tar bort alle stasjonsnummerene, og kaller H√•√∏ya for ¬´Reference station¬ª, Hasseldalen for ¬´Outer Vikkilen¬ª, ¬´Shipyard¬ª og ¬´Inner Vikkilen¬ª heter det samme.  
3. Vi tar bort den stiplede r√∏de linjen for 2016. Den markerer sedimenttiltak, men nedgangen skjer f√∏r tiltaket i 2016. Nedgangen skyldes heller forbudet i 2008, og redusert aktivitet p√• verftet frem til fjerning av t√∏rrdokka i 2012.  
4. Vi vil gjerne at avstanden m√•les fra Shipyard, slik at denne er 0 km. Vi har et TBT-resultat til for Skjeviga, og n√•r den sl√•s sammen med B√•tst√∏ s√• f√•r vi inn stiplet svart linje.  

#### Modification 3  
From: Merete Sch√∏yen <merete.schoyen@niva.no> 
Sent: fredag 12. juni 2020 16:35

Jeg jobber (i sommervarmen) med intersex-artikkelen for Vikkilen, og lurer p√• om du kan justere korrelasjonsfigurene nedenfor ved √• sl√• sammen stasjonene 5 og 5 b, slik du gjorde for ISI-TBT i SETAC-presentasjonen? Da skal stasjonene hete: Reference station, Outer Vikkilen, Skjeviga, Shipyard og Inner Vikkilen. Kendall korrelasjonene vil kanskje endre seg da.
`06_Correlations_Litt_ISI_vs_PRL_col.png`
(Part 4 'PRL_mean vs. ISI')
`06_Correlations_Litt_PRL_vs_TBT_col.png`
(Part 4 'PRL_mean vs. TBT')

Har du ogs√• mulighet for √• sl√• sammen 5 og 5 b for all biota samlet? Jeg tror at vi lar stasjonene 2 og 3 med kun bl√•skjell utg√•. Samme stasjonsnavn her: Reference station (5.5 km), Outer Vikkilen (1.5 km), Skjeviga (0.1 km), Shipyard (0 km) og Inner Vikkilen (0.5 km).
`06_Timeseries_allsp_TBT_2_log.png`
(Part 8 'Plot biota TBT at all stations (logistic)')

#### Modification 3b  

From: Merete Sch√∏yen <merete.schoyen@niva.no> 
Sent: torsdag 18. juni 2020 15:23

Dette var fint! Kan du likevel justere figurene mht. dette:
‚Ä¢	ISI og ikke ISE (p√• korrelasjonsfiguren ISI-FPrL).
‚Ä¢	Ikke mean TBT, er vel bare basert p√• kun √©n blandpr√∏ve, s√• dropp mean. Det kan ogs√• bare st√• ISI og FPrL og ikke mean (det ligger i definisjonene).
‚Ä¢	Figurtekst L. littorea. N. reticulatus, B. undatum, N. lapillus ( i denne rekkef√∏lgen), istedenfor Buccinum, Littorina, Nassarius og Nucella. Dropp Station i figurtekstene.

Kan du ogs√• lage en ny korrelasjonsfigur med samme layout for ISI og TBT?
Hva er Kendall korrelasjonene n√• for ISI-TBT, ISI-FPrL og FPrL-TBT?



## 0. Libraries
```{r}
library(dplyr)
library(purrr)    # transpose
library(ggplot2)
library(tidyr)
library(forcats)
```

## 0b. Settings
```{r}
save_plots <- TRUE
# save_plots <- FALSE
```


## 0c. Make 5-color palette  
```{r}

# library("colorspace") 
# The line below: run it in the Console (bottom window), NOT here (RStudio will hang)
# pal <-choose_palette()

library(pals)

if (FALSE){
  labs=c('alphabet','alphabet2', 'glasbey','kelly','polychrome', 
         'stepped', 'stepped2', 'stepped3', 'tol', 'watlington')
  op=par(mar=c(0,5,3,1))
  pal.bands(alphabet(), alphabet2(), glasbey(), kelly(), polychrome(), 
            stepped(), stepped2(), stepped3(), tol(), watlington(), 
            labels=labs, show.names=FALSE)

  pal.bands(tol(5), glasbey(5), kelly(7)[3:7])
  pal.bands(brewer.blues(4), brewer.reds(4))

  }


station_cols <- c(
  brewer.blues(4)[c(4,3,2)], 
  brewer.reds(4)[c(4,2)])
pal.bands(station_cols)

```

## 0d. Station names
```{r}
# OLD (before we combined st. 5 and 5b)
st_names <- data.frame(
  Station = c("1", "4", "5", "5b", "6", "7"),
  Station_name = c("St. 1 H√•√∏ya, Outer fjord", "St. 4 Hasseldalen", "St. 5 Skjeviga", 
              "St. 5B B√•tst√∏", "St. 6 Shipyard", "St. 7 Inner Vikkilen")
)

# NEW (after combining st. 5 and 5b)
st_names <- data.frame(
  Station = c("1", "4", "5", "6", "7"),
  Station_name = c("Reference station (5.5 km)", "Outer Vikkilen (2.5 km)", 
                   "Skjeviga (0.1 km)", 
                   "Shipyard (0 km)", "Inner Vikkilen (0.5 km)"),
  stringsAsFactors = FALSE
  ) %>%
  mutate(Station_name = fct_inorder(Station_name))  # set as factor, for correct order
  
names(station_cols) <- st_names$Station_name

```


## 1. Data

### a. dat_tbt_mean - all species
16 April 2020: 
- Combine 5 and 5B
```{r}
dat_intersex_litt <- readRDS(file = "Data/02_Strandsnegl_intersex_2005_2018.RData") %>%
  mutate(Station = case_when(Station %in% "St6" ~ "6",
                             TRUE ~ Station),
         Sex = case_when(tolower(Sex) %in% "f" ~ "f",
                         tolower(Sex) %in% "m" ~ "m",
                         TRUE ~ "x")
         )

dat_tbt <- readRDS(file = "Data/05_TBT.RData")


# Summarise TBT
dat_tbt_mean <- dat_tbt %>% 
  mutate(Station = case_when(
    Station %in% "5b" ~ "5",
    Station != "5b" ~ Station
  )) %>% # View()
  group_by(Species, Station, Year) %>%
  summarise(TBT_mean = mean(TBT, na.rm = TRUE), TBT_flag = mean(TBT_flag %in% "<")) %>%
  ungroup()

cat("Raw data \n")
dat_tbt %>% 
  filter(Station %in% c("1","4","5","5b","6","7") & Species == "Littorina") %>%
  xtabs(~Year + Station, .)
cat("\n")

cat("Number of means, 5 and 5B combined \n")
dat_tbt_mean %>% 
  filter(Station %in% c("1","4","5","5b","6","7") & Species == "Littorina") %>%
  xtabs(~Year + Station, .)

# str(dat_tbt_mean)


```

### b. Add station names  
```{r}

dat_tbt_mean <- dat_tbt_mean %>%
  left_join(st_names, by = "Station")

str(dat_tbt_mean)

```

## 2. TBT - tables of species
```{r}
xtabs(~Species, dat_tbt_mean)
xtabs(~Species + Year, dat_tbt_mean)

```

## 3. Littorina data
### a. Chemical data  
```{r}
# xtabs(~Station + df_name, dat_tbt %>% filter(Species %in% "Littorina"))
xtabs(~Station + Year, dat_tbt %>% filter(Species %in% "Littorina"))

tab_tbt <- dat_tbt_mean %>%
  filter(Species %in% "Littorina") %>%
  group_by(Station, Year) %>%
  spread(Year, TBT_mean)

if (save_plots){
  wb <- openxlsx::createWorkbook("DHJ")
  openxlsx::addWorksheet(wb, "Littorina TBT")
  openxlsx::writeData(wb, sheet = 1, tab_tbt)
  openxlsx::saveWorkbook(wb, "Figures/06_Littorina_tables.xlsx", overwrite = TRUE)
}
tab_tbt
```

### b. Intersex data
```{r}
dat_intersex_litt %>%
  count(Sex, Female, Male)

dat_intersex_litt %>%
  count(Station, Year, Sex) %>%
  spread(Sex, n)

```

### c1. Mean data per staion/year, and add TBT  
dat_intersex_litt_summ 

- percentage sterile females (%S) = (number of sterile females/total number of females)*100  
    - stage 2-4 females are sterile  
- mean Female Penis Length (FPL)  
- mean Male Penis Length (MPL)  
- For N. lapillus,  
    - Relative Penis Size Index (RPSI) = (FPL)3/(MPL)3*100   
- imposex index (VDSI) = (sum of the values of imposex stages (ranged 0 to 5) in all females/the number of females collected)  
  
16 April 2020: 
- Combine 5 and 5B
```{r}
dat_intersex_litt_summ <- dat_intersex_litt %>%
  ungroup() %>%
  mutate(Station = case_when(
    Station %in% "5b" ~ "5",
    Station != "5b" ~ Station
  )) %>% # View()
  group_by(Station, Year, Sex) %>%
  summarize(ISI_mean = mean(ISI, na.rm = FALSE),
            N_ISI = sum(!is.na(ISI)),
            Sterile_perc = mean((ISI >= 2)*100, na.rm = TRUE),
            PRL_mean = mean(PRL, na.rm = TRUE)) %>%
  ungroup()

nrow(dat_intersex_litt_summ)

# Add TBT_mean, TBT_flag
dat_intersex_litt_summ <- dat_intersex_litt_summ %>%
  left_join(dat_tbt_mean %>% 
              ungroup() %>%
              filter(Species %in% "Littorina") %>%
              mutate(Sex = "f") %>%    # to avoid that data are duplicated 
              select(Station, Year, Sex, TBT_mean, TBT_flag), 
            by = c("Station", "Year", "Sex")
            )

nrow(dat_intersex_litt_summ)

```

### c2. Add station names  
```{r}


dat_intersex_litt_summ <- dat_intersex_litt_summ %>%
  left_join(st_names, by = "Station")


# str(dat_intersex_litt_summ)
# dat_intersex_litt_summ$Station


```


### d. Overview tables of mean values
```{r}
tab_ISI <- dat_intersex_litt_summ %>%
  filter(Sex %in% "f") %>%
  mutate(ISI_mean = round(ISI_mean, 2)) %>%
  select(Station, Year, ISI_mean) %>%
  spread(Year, ISI_mean)
tab_ISI

tab_PRL <- dat_intersex_litt_summ %>%
  filter(Sex %in% "f") %>%
  mutate(PRL_mean = round(PRL_mean, 2)) %>%
  select(Station, Year, PRL_mean) %>%
  filter(!is.na(PRL_mean)) %>%
  spread(Year, PRL_mean)
tab_PRL

tab_sterile <- dat_intersex_litt_summ %>%
  filter(Sex %in% "f") %>%
  mutate(Sterile_perc = round(Sterile_perc, 1)) %>%
  select(Station, Year, Sterile_perc) %>%
  filter(!is.na(Sterile_perc)) %>%
  spread(Year, Sterile_perc)
tab_sterile

dat_intersex_litt_summ %>%
  mutate(PRL_mean = round(PRL_mean, 2)) %>%
  select(Station, Year, Sex, PRL_mean) %>%
  spread(Sex, PRL_mean)

if (save_plots){
  openxlsx::addWorksheet(wb, "Littorina ISI")
  openxlsx::writeData(wb, sheet = "Littorina ISI", tab_ISI)
  openxlsx::addWorksheet(wb, "Littorina sterile")
  openxlsx::writeData(wb, sheet = "Littorina sterile", tab_ISI)
  openxlsx::addWorksheet(wb, "Littorina PRL")
  openxlsx::writeData(wb, sheet = "Littorina PRL", tab_PRL)
  openxlsx::saveWorkbook(wb, "Figures/06_Littorina_tables.xlsx", overwrite = TRUE)
}
tab_tbt
```

## 4. Littorina correlation figures

### ISI vs TBT

```{r, fig.height =4, fig.width=6}
gg <- ggplot(dat_intersex_litt_summ, aes(TBT_mean, ISI_mean)) +
  geom_smooth(method = "lm", color = "black") +
  labs(x = "TBT (Œºg/kg w.w.)", y = "ISI")

gg1 <- gg +
  geom_point(aes(fill = Station_name), pch = 21, size = rel(2)) +
  scale_fill_manual("", values = station_cols)

gg2 <- gg +
  geom_point(aes(shape = Station_name), size = rel(2))

if (save_plots){
  ggsave("Figures/06_Correlations_Litt_ISI_vs_TBT_col.png", gg1, 
         width = 7, height = 5, dpi = 500)
  ggsave("Figures/06_Correlations_Litt_ISI_vs_TBT_bw.png", gg2, 
         width = 7, height = 5, dpi = 500)
}
gg1
gg2


```

### PRL_mean vs. TBT

```{r, fig.height =4 fig.width =6}
gg <- ggplot(dat_intersex_litt_summ, aes(TBT_mean, PRL_mean)) +
  geom_smooth(method = "lm") +
  labs(x = "TBT (Œºg/kg w.w.)", y = "FPrL")

gg1 <- gg + scale_color_brewer(palette = "Dark2") +
  geom_point(aes(fill = Station_name), pch = 21, size = rel(2)) +
  scale_fill_manual("", values = station_cols)

gg2 <- gg + scale_color_brewer(palette = "Dark2") +
  geom_point(aes(shape = Station_name), size = rel(2))

if (save_plots){
  ggsave("Figures/06_Correlations_Litt_PRL_vs_TBT_col.png", gg1, 
         width = 7, height = 5, dpi = 500)
  ggsave("Figures/06_Correlations_Litt_PRL_vs_TBT_bw.png", gg2, 
         width = 7, height = 5, dpi = 500)
}
gg1
gg2


```


### PRL_mean vs. ISI
```{r, fig.height =4, fig.width=6}

gg <- ggplot(dat_intersex_litt_summ, aes(PRL_mean, ISI_mean)) +
  geom_smooth(method = "lm", color = "black") +
  labs(x = "FPrL", y = "ISI")

gg1 <- gg + scale_color_brewer(palette = "Dark2") +
  geom_point(aes(fill = Station_name), pch = 21, size = rel(2)) +
  scale_fill_manual("", values = station_cols)

gg2 <- gg + scale_color_brewer(palette = "Dark2") +
  geom_point(aes(shape = Station_name), size = rel(2))

# save_plots <- TRUE
if (save_plots){
  ggsave("Figures/06_Correlations_Litt_ISI_vs_PRL_col.png", gg1, 
         width = 7, height = 5, dpi = 500)
  ggsave("Figures/06_Correlations_Litt_ISI_vs_PRL_bw.png", gg2, 
         width = 7, height = 5, dpi = 500)
}
gg1
gg2


```

### Correlations
```{r, fig.height = 5, fig.width=6}

cat("=================================\nCorrelation TBT_mean, ISI_mean \n\n")
with(dat_intersex_litt_summ, cor.test(TBT_mean, ISI_mean, method = "kendall"))

cat("=================================\nCorrelation TBT_mean, PRL_mean \n\n")
with(dat_intersex_litt_summ, cor.test(TBT_mean, PRL_mean, method = "kendall"))

cat("=================================\nCorrelation PRL_mean, ISI_mean \n\n")
with(dat_intersex_litt_summ, cor.test(PRL_mean, ISI_mean, method = "kendall"))

```

### TBT vs time, all stations   
```{r, fig.height = 5, fig.width=6}
# TBT_mean vs. Time, for all stations combined - actually significan 
with(dat_intersex_litt_summ, cor.test(TBT_mean, Year, method = "kendall"))

# ANCOVA TBT_mean vs. time, adjusted for station 
mod <- lm(log(TBT_mea√∏n) ~ Year + Station, data = dat_intersex_litt_summ)
summary(mod)
visreg::visreg(mod)

# As above, excluding the reference station
mod <- lm(log(TBT_mean) ~ Year + Station, data = dat_intersex_litt_summ %>% filter(Station != 1))
summary(mod)
visreg::visreg(mod)

# As above, excluding years before 2010
mod <- lm(log(TBT_mean) ~ Year + Station, data = dat_intersex_litt_summ %>% filter(Year >= 2010))
summary(mod)
visreg::visreg(mod)

# Plot 
gg <- ggplot(dat_intersex_litt_summ, aes(Year, TBT_mean)) +
  geom_smooth(method = "lm") + 
  scale_color_brewer(palette = "Dark2") +
  geom_point(aes(shape = Station), size = rel(2))
gg

# ?visreg::visreg
```

## 5. Littorina time series plots

  ### TBT

```{r}
ggplot(dat_intersex_litt_summ, aes(Year, TBT_mean)) +
  geom_point() +
  facet_wrap(vars(Station))
```

###  ISI
```{r}
ggplot(dat_intersex_litt_summ, aes(Year, ISI_mean)) +
  geom_point() +
  facet_wrap(vars(Station))

```

### Mean PRL
```{r}
ggplot(dat_intersex_litt_summ, aes(Year, PRL_mean)) +
  geom_point() +
  facet_wrap(vars(Station))

```


### Mean PRL
```{r}
ggplot(dat_intersex_litt_summ, aes(Year, PRL_mean)) +
  geom_point() +
  facet_wrap(vars(Station))

```

## 6. Littorina plots using logistic function
```{r}
source("06_Tables_graphs_functions.R")
```


### Example for TBT 
```{r}
st <- "7"
df <- dat_intersex_litt_summ %>% filter(Station %in% st & !is.na(TBT_mean))
df_pred <- pred_logistic(df$Year, df$TBT_mean, x_range = c(2005, 2018))

plot(TBT_mean ~ Year, data = df, type = "n", xlab = "", ylab = "") 
with(df_pred$fit, polygon.lines(x, Pred_lo, Pred_hi, border = FALSE)) 
with(df_pred$fit, lines(x, Pred)) 
with(df, points(Year, TBT_mean, pch = 19)) 

```


### Example for ISI 
```{r}
st <- "7"
df <- dat_intersex_litt_summ %>% filter(Station %in% st & !is.na(ISI_mean))
df_pred <- pred_logistic(df$Year, df$ISI_mean, x_range = c(2005, 2018), a = 0.05)

plot(ISI_mean ~ Year, data = df, type = "n", xlab = "", ylab = "") 
with(df_pred$fit, polygon.lines(x, Pred_lo, Pred_hi, border = FALSE)) 
with(df_pred$fit, lines(x, Pred)) 
with(df, points(Year, ISI_mean, pch = 19)) 

```

### ISI, ggplot variant
```{r}
pvalue <- summary(df_pred$model)$coef["x","Pr(>|t|)"]
ggplot() + 
  geom_ribbon(data = df_pred$fit, aes(x, ymin = Pred_lo, ymax = Pred_hi), fill = "grey70") +
  geom_path(data = df_pred$fit, aes(x, y = Pred)) +
  annotate("text", x = 2016, y = 1.3, label = paste("P =", round(pvalue, 4)))
```

### Plot two stations
```{r}
predlist <- list(
  pred_logistic_from_stationname("6", "ISI_mean"),
  pred_logistic_from_stationname("7", "ISI_mean")
)

# Combine
df_pred <- bind_rows(predlist[[1]]$fit, predlist[[2]]$fit)
df_pvalue <- bind_rows(predlist[[1]]$pvalue, predlist[[2]]$pvalue)
df <- dat_intersex_litt_summ %>% filter(Station %in% c("6","7") & !is.na(ISI_mean))

# Plot
ggplot() + 
  geom_ribbon(data = df_pred, aes(x, ymin = Pred_lo, ymax = Pred_hi), fill = "grey70") +
  geom_path(data = df_pred, aes(x, y = Pred)) +
  geom_point(data = df, aes(Year, ISI_mean)) +
  geom_text(data = df_pvalue, aes(x = 2016, y = Inf, label = Text), vjust = 1.2) +
  facet_wrap(vars(Station))

```

### Plot ISI at all stations
```{r}
sts <- unique(dat_intersex_litt_summ$Station)
df_pred_list <- sts %>% lapply(pred_logistic_from_stationname, variable = "ISI_mean")
names(df_pred_list) <- sts
# df_pred_list[["5b"]]

# Collect data for plotting 
df_pred <- bind_rows(transpose(df_pred_list)$fit)
df_pvalue <- bind_rows(transpose(df_pred_list)$pvalue)
df <- dat_intersex_litt_summ %>% filter(!is.na(ISI_mean))

# Plot
ggplot() + 
  geom_ribbon(data = df_pred, aes(x, ymin = Pred_lo, ymax = Pred_hi), fill = "grey70") +
  geom_path(data = df_pred, aes(x, y = Pred)) +
  geom_point(data = df, aes(Year, ISI_mean)) +
  geom_text(data = df_pvalue, aes(x = 2016, y = Inf, label = Text), vjust = 1.2) +
  facet_wrap(vars(Station))

```


### Plot percent sterile at all stations
```{r}
# Run all stations (as above)
sts <- unique(dat_intersex_litt_summ$Station)
df_pred_list <- sts %>% lapply(pred_logistic_from_stationname, variable = "Sterile_perc")
names(df_pred_list) <- sts

# Check p-values
transpose(df_pred_list)$pvalue %>% bind_rows()

# Run 4 using linear regression
df_pred_list[["4"]] <- pred_linear_from_stationname("4", "Sterile_perc")

# Collect data for plotting 
df_pred <- bind_rows(transpose(df_pred_list)$fit)
df_pvalue <- bind_rows(transpose(df_pred_list)$pvalue)
df <- dat_intersex_litt_summ %>% filter(!is.na(Sterile_perc))

# Plot
gg <- ggplot() + 
  geom_ribbon(data = df_pred, aes(x, ymin = Pred_lo, ymax = Pred_hi), fill = "grey70") +
  geom_path(data = df_pred, aes(x, y = Pred)) +
  geom_point(data = df, aes(Year, Sterile_perc)) +
  geom_text(data = df_pvalue, aes(x = 2016, y = Inf, label = Text), vjust = 1.2) +
  facet_wrap(vars(Station)) +
  labs(title = "Percent of sterile females", x = "Year", y = "Percent sterile")
if (save_plots)
  ggsave("Figures/06_Timeseries_Litt_sterile.png", gg)
gg

```


### Plot PRL at all stations
```{r}
# We make regressions for only two stations
sts <- c("6", "7")
df_pred_list <- sts %>% lapply(pred_logistic_from_stationname, variable = "PRL_mean")
names(df_pred_list) <- sts
# df_pred_list[["5b"]]

# Collect data for plotting 
df_pred <- bind_rows(transpose(df_pred_list)$fit)
df_pvalue <- bind_rows(transpose(df_pred_list)$pvalue)
df <- dat_intersex_litt_summ %>% filter(!is.na(PRL_mean))

# Plot
gg <- ggplot() + 
  geom_ribbon(data = df_pred, aes(x, ymin = Pred_lo, ymax = Pred_hi), fill = "grey70") +
  geom_path(data = df_pred, aes(x, y = Pred)) +
  geom_point(data = df, aes(Year, PRL_mean)) +
  geom_text(data = df_pvalue, aes(x = 2016, y = Inf, label = Text), vjust = 1.2) +
  facet_wrap(vars(Station)) +
  labs(title = "PRL", x = "Year", y = "Mean PRL")
if (save_plots)
  ggsave("Figures/06_Timeseries_Litt_PRL.png", gg)
gg
```

### Plot TBT at all stations
```{r}
# Run all stations (as above)
sts_tbt <- dat_intersex_litt_summ %>%
  ungroup() %>%
  filter(!is.na(TBT_mean)) %>%
  count(Station) %>%
  filter(n >= 3) %>%
  pull(Station)

# debugonce(pred_logistic_from_stationname)
df_pred_list <- sts_tbt %>% lapply(pred_logistic_from_stationname, variable = "TBT_mean")
names(df_pred_list) <- sts_tbt

# Run 5b using linear regression
# df_pred_list[["5b"]] <- pred_linear_from_stationname("5b", "ISI_mean")

# Collect data for plotting 
df_pred_tbt <- bind_rows(transpose(df_pred_list)$fit)
df_pvalue_tbt <- bind_rows(transpose(df_pred_list)$pvalue)
df_points_tbt <- dat_intersex_litt_summ %>% filter(!is.na(TBT_mean))

# Plot
gg <- ggplot() + 
  geom_ribbon(data = df_pred_tbt, aes(x, ymin = Pred_lo, ymax = Pred_hi), fill = "grey70") +
  geom_path(data = df_pred_tbt, aes(x, y = Pred)) +
  geom_point(data = df_points_tbt, aes(Year, TBT_mean)) +
  geom_text(data = df_pvalue_tbt, aes(x = 2016, y = Inf, label = Text), vjust = 1.2) +
  facet_wrap(vars(Station)) +
  labs(title = "TBT", x = "Year", y = "TBT concentration")
if (save_plots)
  ggsave("Figures/06_Timeseries_Litt_TBT.png", gg)
gg

```

## 7. Combined figures, ISI + TBT

### Data
```{r}

# # OLD (before we combined st. 5 and 5b)
# st_names <- data.frame(
#   Station = c("1", "4", "5", "5b", "6", "7"),
#   Station_name = c("St. 1 H√•√∏ya, Outer fjord", "St. 4 Hasseldalen", "St. 5 Skjeviga", 
#               "St. 5B B√•tst√∏", "St. 6 Shipyard", "St. 7 Inner Vikkilen")
# )
# 
# # NEW (after combining st. 5 and 5b)
# st_names <- data.frame(
#   Station = c("1", "4", "5", "6", "7"),
#   Station_name = c("Reference station", "Outer Vikkilen", "Skjeviga", 
#                    "Shipyard", "Inner Vikkilen")
# )
# 
# dat_intersex_litt_summ <- dat_intersex_litt_summ %>%
#   left_join(st_names, by = "Station")
# 
# # In orddr to get correct order in plots
# dat_intersex_litt_summ$Station_name <- factor(dat_intersex_litt_summ$Station_name,
#                                               levels = c("Reference station", "Outer Vikkilen", 
#                                                 "Skjeviga", "Shipyard", "Inner Vikkilen"))
# 
# # dat_intersex_litt_summ$Station


```

### Get predicted (fitted) lines   
```{r}
#
# ISI
#

sts <- unique(dat_intersex_litt_summ$Station)
df_pred_list <- sts %>% lapply(pred_logistic_from_stationname, variable = "ISI_mean")
names(df_pred_list) <- sts

# Check p-values<
transpose(df_pred_list)$pvalue %>% bind_rows()

# For those with pvalue > 0.05, we use a flat line instead for these:
for (st in c("1","4"))
  df_pred_list[[st]] <- pred_flat_from_stationname(st, "ISI_mean")

# Collect data for plotting 
df_pred_isi <- bind_rows(transpose(df_pred_list)$fit)
df_pvalue_isi <- bind_rows(transpose(df_pred_list)$pvalue)
df_points_isi <- dat_intersex_litt_summ %>% filter(!is.na(ISI_mean))

# In orddr to get correct order in plots
# Only needed for df_pred_isi, since that is the one used in ggplot()
df_pred_isi$Station_name <- factor(df_pred_isi$Station_name,
                                   levels = c("Reference station", "Outer Vikkilen", 
                                              "Skjeviga", "Shipyard", "Inner Vikkilen"))


#
# TBT (sts_tbt defined in previous chunk)
#
# debugonce(pred_logistic_from_stationname)
df_pred_list <- sts_tbt %>% lapply(pred_logistic_from_stationname, variable = "TBT_mean")
names(df_pred_list) <- sts_tbt

# Check p-values
transpose(df_pred_list)$pvalue %>% bind_rows()

# pvalue > 0.05, so we use a flat line instead for these:
for (st in c("5","6"))
  df_pred_list[[st]] <- pred_flat_from_stationname(st, "TBT_mean")

# Collect data for plotting 
df_pred_tbt <- bind_rows(transpose(df_pred_list)$fit)
df_pvalue_tbt <- bind_rows(transpose(df_pred_list)$pvalue)
df_points_tbt <- dat_intersex_litt_summ %>% filter(!is.na(TBT_mean))

# Test plots for each separately
if (FALSE) {
  ggplot() + 
    # geom_ribbon(data = df_pred_isi, aes(x, ymin = Pred_lo, ymax = Pred_hi), fill = "grey70") +
    geom_path(data = df_pred_isi, aes(x, y = Pred)) +
    geom_point(data = df_points_isi, aes(Year, ISI_mean)) +
    # geom_text(data = df_pvalue_isi, aes(x = 2016, y = Inf, label = Text), vjust = 1.2) +
    facet_wrap(vars(Station)) +
    labs(title = "ISI", x = "Year", y = "ISI")
  
  ggplot() + 
    geom_path(data = df_pred_tbt, aes(x, y = Pred)) +
    geom_point(data = df_points_tbt, aes(Year, TBT_mean)) +
    facet_wrap(vars(Station)) +
    labs(title = "TBT", x = "Year", y = "TBT concentration")
  
}

```

### Plotting ISI + TBT combination   
THIS IS A MESS NOW  - DUE TO DIFFERENT FACTOR LEVELS
Method from https://stackoverflow.com/a/53703152/1734247 
```{r}
ylim.prim <- c(0, 3.5)     # ISI
ylim.sec <- c(0, 510)    # TBT
cols <- RColorBrewer::brewer.pal(8, "Dark2")

b <- diff(ylim.prim)/diff(ylim.sec)
a <- b*(ylim.prim[1] - ylim.sec[1])

# OLD (before we combined st. 5 and 5b)
df_km <- data.frame(
  Station_name = c("St. 1 H√•√∏ya, Outer fjord", "St. 4 Hasseldalen", "St. 5 Skjeviga", 
                   "St. 5B B√•tst√∏", "St. 6 Shipyard", "St. 7 Inner Vikkilen"),
  Km = c("6 km", "2 km", "0.6 km", "0.55 km", "0.5 km", "0 km"),
  stringsAsFactors = FALSE
)

# NEW (for SETAC)
df_km <- data.frame(
  Station_name = c("Reference station", "Outer Vikkilen", "Skjeviga", 
                   "Shipyard", "Inner Vikkilen"),
  Km = c("5.5 km", "1.5 km", "0.1 km", "0 km", "0.5 km"),
  stringsAsFactors = FALSE
)

# For correct order in plot
df_km$Station_name <- factor(df_km$Station_name,
                             levels = c("Reference station", "Outer Vikkilen", 
                                        "Skjeviga", "Shipyard", "Inner Vikkilen"))

gg <- ggplot() + 
  geom_path(data = df_pred_isi, aes(x, y = Pred), color = cols[1]) +
  geom_point(data = df_points_isi, aes(Year, ISI_mean), color = cols[1]) +
  geom_path(data = df_pred_tbt, aes(x, y = a + b*Pred), color = cols[2]) +
  geom_point(data = df_points_isi, aes(Year, a + b*TBT_mean), color = cols[2]) +
  geom_text(data = df_km, aes(x = 2016, y = Inf, label = Km), vjust = 1.2) +
  scale_y_continuous("ISI", sec.axis = sec_axis(~ (. - a)/b, name = "TBT")) +
  facet_wrap(vars(Station_name)) +
  labs(title = "ISI and TBT", x = "Year") + 
  theme_bw() +
    theme(
        axis.line.y.left = element_line(color = cols[1]), 
        axis.ticks.y.left = element_line(color = cols[1]),
        axis.text.y.left = element_text(color = cols[1]), 
        axis.title.y.left = element_text(color = cols[1]),
        axis.line.y.right = element_line(color = cols[2]), 
        axis.ticks.y.right = element_line(color = cols[2]),
        axis.text.y.right = element_text(color = cols[2]), 
        axis.title.y.right = element_text(color = cols[2])
        )

if (save_plots)
  ggsave("Figures/06_Timeseries_Comb_ISI_TBT.png", gg, 
         width = 7, height = 5, dpi = 500)

gg


```

#### B/W

```{r}



cols2 <- c("black", "black")

gg <- ggplot() + 
  geom_ribbon(data = df_pred_isi, aes(x, ymin = Pred_lo, ymax = Pred_hi), 
              fill = "grey70", alpha = 0.5) +
  geom_path(data = df_pred_isi, aes(x, y = Pred), color = cols2[1]) +
  geom_point(data = df_points_isi, aes(Year, ISI_mean), color = cols2[1]) +
  geom_ribbon(data = df_pred_tbt, aes(x, ymin = a + b*Pred_lo, ymax = a + b*Pred_hi), 
              fill = "grey70", alpha = 0.5) +
  geom_path(data = df_pred_tbt, aes(x, y = a + b*Pred), color = cols2[2],
            linetype = 2) +
  geom_point(data = df_points_isi, aes(Year, a + b*TBT_mean), color = cols2[2],
             shape = 17) +
  geom_vline(xintercept = c(2008), color = "red2", linetype = 2) +
  geom_text(data = df_km, aes(x = 2016, y = Inf, label = Km), vjust = 1.2) +
  scale_y_continuous("ISI (circles)", 
                     sec.axis = sec_axis(~ (. - a)/b, name = "TBT (triangles)")) +
  facet_wrap(vars(Station_name)) +
  labs(title = "ISI and TBT", x = "Year") + 
  theme_bw() +
    theme(
        axis.line.y.left = element_line(color = cols2[1]), 
        axis.ticks.y.left = element_line(color = cols2[1]),
        axis.text.y.left = element_text(color = cols2[1]), 
        axis.title.y.left = element_text(color = cols2[1]),
        axis.line.y.right = element_line(color = cols2[2]), 
        axis.ticks.y.right = element_line(color = cols2[2]),
        axis.text.y.right = element_text(color = cols2[2]), 
        axis.title.y.right = element_text(color = cols2[2])
        )

if (save_plots)
#  ggsave("Figures/06_Timeseries_Comb_ISI_TBT_bw.png", gg, 
#         width = 7, height = 5, dpi = 500)

gg

# ?points
```



## 8. TBT - all species

### Add 'Species2' (actual species name, not genus)   
```{r}

dat_tbt_mean <- dat_tbt_mean %>%
  mutate(Species2 =
           case_when(
             Species %in% "Buccinum" ~ "B. undatum",
             Species %in% "Littorina" ~ "L. littorea",
             Species %in% "Nassarius" ~ "N. reticulatus",
             Species %in% "Nucella" ~ "N. lapillus",
             Species %in% "Mytilus" ~ "M. edulis"
           ),
         Species2 = factor(Species2, 
                           levels = c("L. littorea", "N. reticulatus", 
                                      "B. undatum", "N. lapillus", "M. edulis"))
         ) 

```

### Plot biota TBT at all stations (linear)
```{r, fig.height = 5, fig.width=8}

# Run all stations (as above)
gg <- dat_tbt_mean %>%
  filter(!Species %in% c("Sediment", "Mytilus")) %>%
  filter(!is.na(TBT_mean)) %>%
  ggplot(aes(Year, TBT_mean)) +
    geom_point(aes(color = Species2)) + 
    geom_smooth(method = "lm") +
    facet_wrap(vars(Station_name))

if (save_plots){
  ggsave("Figures/06_Timeseries_allsp_TBT_1.png", gg)
  ggsave("Figures/06_Timeseries_allsp_TBT_1_log.png", gg + scale_y_log10())
}

gg
gg + scale_y_log10()

```




### Plot biota TBT at all stations (logistic)   

```{r, fig.height = 5, fig.width=8}

df <- dat_tbt_mean %>%
  filter(!Species %in% c("Sediment", "Mytilus")) %>%
  filter(!is.na(TBT_mean))
sts <- unique(df$Station_name)
# sts <- c("1", "4", "5", "6", "7")
pred_list <- sts %>% lapply(
  function(st) {
    df_station <- df %>% filter(Station_name %in% st)
    result <- pred_logistic_from_data(df_station, variable = "TBT_mean")
    result$fit$Station_name <- st
    result$pvalue$Station_name <- st
    result
  })
names(pred_list) <- sts

str(pred_list, 1)       # List of 5
str(pred_list[[1]], 1)  # List of 2: $fit  and $pvalue
  
# Collect data for plotting 
df_pred <- bind_rows(transpose(pred_list)$fit)
df_pvalue <- bind_rows(transpose(pred_list)$pvalue)

# Plot
gg <- ggplot() + 
  geom_ribbon(data = df_pred, aes(x, ymin = Pred_lo, ymax = Pred_hi), fill = "grey70") +
  geom_path(data = df_pred, aes(x, y = Pred)) +
  geom_point(data = df, aes(Year, TBT_mean, fill = Species2), size = 2, pch = 21) +
  scale_fill_discrete("Species") +
  geom_text(data = df_pvalue, aes(x = 2016, y = Inf, label = Text), vjust = 1.2) +
  facet_wrap(vars(Station_name)) +
  labs(title = "TBT", x = "Year", y = "TBT concentration")

if (save_plots){
  ggsave("Figures/06_Timeseries_allsp_TBT_2.png", 
         gg,
         width = 8, height = 5, dpi = 500)
  ggsave("Figures/06_Timeseries_allsp_TBT_2_log.png", 
         gg + scale_y_log10(limits = c(0.3, 900)),
         width = 8, height = 5, dpi = 500)
}

gg
gg + scale_y_log10(limits = c(0.3, 900))

```

### Plot sediment TBT at all stations
```{r, fig.height = 5, fig.width=7.5}
# Run all stations (as above)
gg <- dat_tbt_mean %>%
  filter(Species %in% "Sediment") %>%
  filter(Station %in% c("1", "2", "3", "4", "5", "6")) %>%
  filter(!is.na(TBT_mean)) %>%
  ggplot(aes(Year, TBT_mean)) +
    geom_point(aes(color = Species)) + 
    geom_smooth(method = "lm", se = FALSE) +
    facet_wrap(vars(Station))

gg
gg + scale_y_log10()

if (save_plots)
  ggsave("Figures/06_Timeseries_TBT_sediment_log.png", gg + scale_y_log10())
gg

```

### Plot blue mussel TBT at all stations
```{r, fig.height = 5, fig.width=7.5}
# Run all stations (as above)
gg <- dat_tbt_mean %>%
  filter(Species %in% "Mytilus") %>%
  filter(Station %in% c("1", "2", "3", "4", "5", "6")) %>%
  filter(!is.na(TBT_mean)) %>%
  ggplot(aes(Year, TBT_mean)) +
    geom_point(aes(color = Species)) + 
    geom_smooth(method = "lm", se = FALSE) +
    facet_wrap(vars(Station))

gg
gg + scale_y_log10()

if (save_plots)
  ggsave("Figures/06_Timeseries_TBT_bluemussel_log.png", gg + scale_y_log10())
gg

```



### Plot TBT in blue mussel vs. TBT in Littorina  
```{r, fig.height = 5, fig.width=7.5}
# Run all stations (as above)
df <- dat_tbt_mean %>%
  filter(Species %in% c("Littorina", "Mytilus")) %>%
  filter(Station %in% c("1", "4", "5", "6")) %>%
  filter(!is.na(TBT_mean)) %>%
  select(Species2, Station_name, Year, TBT_mean) %>%
  # count(Species2, Station_name, Year) %>% filter(n > 1)    # for checking dublettes
  tidyr::pivot_wider(names_from = Species2, values_from = TBT_mean) %>%
  filter(!is.na(`M. edulis`) & !is.na(`L. littorea`))
nrow(df)

gg <- ggplot(df, aes(`L. littorea`, `M. edulis`)) +
    geom_point(aes(fill = Station_name), size = 2, pch = 21) +
  scale_fill_manual(values = station_cols) +
    geom_smooth(method = "lm", se = FALSE) +
  labs(x = "TBT in L. littorea (Œºg/kg w.w.)", 
       y = "TBT in M. edulis (Œºg/kg w.w.)")

if (save_plots)
  ggsave("Figures/06_Correlations_TBT_bluemussel_vs_Littorina.png", gg,
         width = 7, height = 5, dpi = 500)

cat("=================================\nCorrelation of TBT values \n\n")
with(df, cor.test(`L. littorea`, `M. edulis`, method = "kendall"))

gg


```


